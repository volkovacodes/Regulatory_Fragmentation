---
title: "Tables and Figures"
author: "Kalmenovitz, Lowry, Volkova"
date: "2023-07-14"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
  word_document: 
    fig_caption: yes
    fig_height: 3.65
    fig_width: 7.5
    reference_docx: /Users/evolkova/Dropbox/style_reference.docx
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

require(pacman)
p_load(ggplot2, data.table, lubridate, ggthemes, dplyr, RColorBrewer, rmarkdown, knitr, modelsummary, fixest, flextable, psych, wordcloud, lfe, kableExtra, tidyverse)

set_flextable_defaults(font.size = 10,
                       font.family = "Times New Roman",
                       hansi.family = "Times New Roman")

options("modelsummary_stars_note" = FALSE)

path <- "/Users/evolkova/Dropbox/Projects/Govt Agenda/"

temp_path <- path %>%
  paste0("Sandbox/20201029/temp_files/")

data_path <- path %>%
  paste0("/Data/")

th1 <- function() {
  theme(axis.line = element_line(size=rel(1), colour = "black"), 
        panel.grid.major = element_line(colour = "#d3d3d3"), 
        panel.grid.minor = element_blank(), 
        panel.border = element_blank(), panel.background = element_blank(),
        plot.title = element_text(size = rel(1.5), family = "Calibri", face = "bold"),
        text=element_text(family="Calibri"), 
        axis.text.x=element_text(colour="black", size = rel(1.3)),
        axis.title.x = element_text(colour="black", size = rel(1.3)),
        axis.title.y = element_text(colour="black", size = rel(1.3)),
        axis.text.y=element_text(colour="black", size = rel(1.4))) +
    theme(plot.title = element_text(hjust = 0.5))
}

th <- function() {
  theme_minimal() + 
  theme(legend.position='bottom', text=element_text(family="Georgia")) +
  theme(legend.title = element_text(size = rel(0.75)), 
        legend.text = element_text(size = rel(0.75)))  
}

win <- function(x, eps = 0.005){
  up <- quantile(x, na.rm = T, 1 - eps)
  down <- quantile(x, na.rm = T, eps)
  x[x>up] <- up
  x[x<down] <- down
  return(x)
}

topics.prob.all <- readRDS(paste0(temp_path, "topics.prob.rds"))
topics.prob <- topics.prob.all[!duplicated(document_number)]

tmp <- topics.prob
for(i in 1:100) tmp[[i]] <- tmp[[i]]*topics.prob$nwords

topiccols <- c(1:100, "nwords")
topics.prob.yeartype <- tmp[, lapply(.SD, . %>% sum), by = .(type,year), .SDcols = topiccols]
topics.prob.year <- tmp[, lapply(.SD, . %>% sum), by = .(year), .SDcols = topiccols]


### load topic to agency
topicstoagencies <- temp_path %>%
  paste0("topicagencyyear.csv") %>%
  fread



wordcloudlist <- "wordcloudlist.rds" %>% 
  paste0(temp_path,.) %>%
  readRDS

labels <- "./Data/topic_labels_ML_KV_JK.csv" %>%
  paste0(path,.) %>% 
  fread

source("/Users/evolkova/Dropbox/Projects/Govt Agenda/Sandbox/main_functions.R")
companyyear <- prep_cy("/Users/evolkova/Dropbox/Projects/Govt Agenda/Data/")

  
### here we correct coefficients names
cm <- c("regul.disp_norm" = "Regulation Dispersion",
        "topic.disp_norm" = "Topic Dispersion",
        "regul.complex.log_norm" = "Regulation Complexity",
        "LogWords10K_norm" = "Log(Word,10K)",
        "Nsegments_norm" = "Nsegments",
        "ppe_at_norm" = "PPE/AT",
        "ebitda_at_norm" = "EBITDA/AT", 
        "emp_sale_norm" = "Emp/Sale",
        "log_sale_norm" = "Log(Sale)",
        "log_at_norm" = "log(AT)",
        "growth_norm" = "Sales Growth",
        "tobin_norm" = "Tobin's Q",
        "fcf_at_norm" = "FCF to AT",
        "(Intercept)" = "(Intercept)")

### here we correct the names
mapagency <- data.table(agency = "environmental protection agency", label = "EPA") %>%
    rbind(list("department of health and human services", "DHHS")) %>%
    rbind(list("department of transportation", "Transportation")) %>%
    rbind(list("department of commerce","Commerce")) %>%
    rbind(list("securities and exchange commission", "SEC")) %>%
    rbind(list("department of interior", "DOI")) %>%
    rbind(list("department of agriculture", "USDA")) %>%
    rbind(list("department of energy", "DOE")) %>%
    rbind(list("department of labor", "DOL")) %>%
    rbind(list("department of treasury", "Treasury")) %>%
    rbind(list("department of justice", "DOJ")) %>%
    rbind(list("nuclear regulatory commission", "NRC")) %>%
    rbind(list("federal communications commission", "FCC")) %>%
    rbind(list("department of housing and urban developm", "HUD")) %>%
    rbind(list("federal reserve system", "FRS")) %>%
    rbind(list("international trade commission", "ITC")) %>% 
    rbind(list("federal energy regulatory commission", "FERC")) %>%
    rbind(list("commodity futures trading commission", "CFTC")) %>%
    rbind(list("department of veteran affairs", "DVA")) %>% 
    rbind(list("consumer financial protection bureau", "CFPB")) %>% 
    rbind(list("department of defense", "Defense")) %>% 
    rbind(list("social security administration", "SSA"))

  
topicagencyyear <- "./Data/topicagencyyear.csv" %>% 
  paste0(path,.) %>% 
  fread()

agencydisp <- topicagencyyear[,list(AgencyDisp = 1 - sum(AgencyPercent^2)),
                              by = "TopicNumber,year"]
  
ff12labels <- "./Data/Indlabels12.txt" %>%
  paste0(path,.) %>%
  readLines
setkey(mapagency, agency)

ms <- function(x){
  out <- modelsummary(x, stars = c('*' = .1, '**' = 0.05 ,'***' = .01),
               gof_map = c("nobs", "r.squared"),
               coef_omit = "(Intercept)|topic|Log|ppe|ebitda|sale|complex|tobin|segm",
               output = "flextable") %>% 
    theme_box() %>% 
    width(width = 1.0) %>% 
    height(height = 0.15)
  return(out)
}

ms_all <- function(x){
  out <- modelsummary(x, stars = c('*' = .1, '**' = 0.05 ,'***' = .01),
              gof_map = c("nobs", "r.squared"), coef_map = cm,
               output = "flextable") %>% 
    theme_box() %>% 
    width(width = 1.0)  %>% 
    height(height = 0.15)
  return(out)
}

controls <- c("regul.disp", "topic.disp", "regul.complex.log","LogWords10K", "ppe_at", "ebitda_at", "log_sale", "tobin", "Nsegments") %>% paste0("_norm")
  
```

# **Figure 1: Total number of words**


# **Figure 2: Topic Clouds**

```{r topic3}
make_cloud <- function(i) {
  wordcloud(wordcloudlist[[i]]$term, wordcloudlist[[i]]$beta, colors = brewer.pal(8, "Dark2"), random.order = F) %>%
    print
}
make_cloud(3) 
```

```{r topic5}
make_cloud(5)
```

```{r topic21}
make_cloud(21)
```

```{r topic23}
make_cloud(23)
```

\newpage

# **Figure 3: Histograms**

*Panel A: Dispersion of agencies per topic*

```{r fig3a, results = "asis", dpi = 300}

data <- topicstoagencies[, list(disp = 1 - sum(AgencyPercent^2)), 
                         by = c("year,TopicNumber")]

bnd <- 0.01
p <- ggplot(data = data, aes(disp)) +
  geom_histogram(aes(y=bnd*..density..), fill="darkgreen",binwidth = bnd, color = "black") + theme_minimal() + 
  xlab("Dispersion of Topics Across Agencies") + ylab("Density [% of topic-year obs]") 

print(p)
```

*Panel B: Dispersion of Topics per firm-year*

$$Topic\_Dispersion_{Firm,Year} = 1 - \sum_{Topic} P^2_{Firm,Topic,year}$$

```{r fig3b, results = "asis", dpi = 300}
bnd <- 0.0025
p <- ggplot(data = companyyear, aes(topic.disp)) +
  geom_histogram(aes(y=bnd*..density..),fill="steelblue", col = "darkblue", bins = 30) + 
  theme_minimal() + xlab("Dispersion of Topics Within Each Firm-Year") + 
  ylab("Density [% of Firm-Year Obs]")

print(p)
```

\newpage

*Panel C: Dispersion of Agencies per Firm-year*

$$RegulationDispersion_{firm,year} = 1- \sum_{Topic} \sum_{Agency}P_{Firm,Topic,year} \cdot \omega_{Topic,Agency,year}^2 = 1 - \sum_{Topic} P_{Firm,Topic,year} \cdot HHI_{Topic,Agency}$$

```{r fig3c, results = "asis", dpi = 300}
bnd <- 0.005
p <- ggplot(data = companyyear[abs(regul.disp) < 1.1], aes(regul.disp)) +
  geom_histogram(aes(y=bnd*..density..), fill="purple",binwidth = bnd, color = "purple4") +
  theme_minimal() + 
  xlab("Regulatory Fragmentation") + ylab("Density [% of firm-year obs]") 
print(p)
```

\newpage

# **Figure 4: Time Trend**

## Panel A: 12 Industries

```{r ff12, results = "asis"}

library(randomcoloR)
n <- 12
pl <- distinctColorPalette(n)

labs <- data.table(ind = 1:12, lab = ff12labels)


companyyear$FF12_lab <- factor(labs[match(companyyear$FF12, labs$ind)]$lab, levels = ff12labels)

companyyear[,mean(regul.disp),by = "FF12_lab,year"] |>
  ggplot(aes(y = V1, x = year, col = FF12_lab, group = FF12_lab)) + 
  geom_line() + theme_minimal() + 
  theme(axis.line = element_line(size=rel(1), colour = "black"), 
        panel.grid.major = element_line(colour = "#d3d3d3"), 
        panel.grid.minor = element_blank(), 
        panel.border = element_blank(), panel.background = element_blank(),
        plot.title = element_text(size = rel(1.5), face = "bold"),
        axis.text.x=element_text(colour="black", size = rel(1.3)),
        axis.title.x = element_text(colour="black", size = rel(1.3)),
        axis.title.y = element_text(colour="black", size = rel(1.3)),
        axis.text.y=element_text(colour="black", size = rel(1.4))) +
    theme(plot.title = element_text(hjust = 0.5)) + xlab("Year") + 
    ylab("Regulatory Fragmentation") + 
    scale_color_manual(values =pl, name = "Industry") + 
  ylim(0.72,0.88)


```

## Panel B: FF12 == 1

```{r ff1, results = "asis"}

pl <- distinctColorPalette(length(unique(companyyear[FF12 == 1]$cik)))

companyyear[FF12 == 1] |>
  ggplot(aes(y = regul.disp, x = year, col = as.character(cik), group = cik)) + 
  geom_line(alpha = 0.5, size = 0.5) + theme_minimal() + 
  theme(legend.position = "none") + 
  theme(axis.line = element_line(size=rel(1), colour = "black"), 
        panel.grid.major = element_line(colour = "#d3d3d3"), 
        panel.grid.minor = element_blank(), 
        panel.border = element_blank(), panel.background = element_blank(),
        plot.title = element_text(size = rel(1.5), face = "bold"),
        axis.text.x=element_text(colour="black", size = rel(1.3)),
        axis.title.x = element_text(colour="black", size = rel(1.3)),
        axis.title.y = element_text(colour="black", size = rel(1.3)),
        axis.text.y=element_text(colour="black", size = rel(1.4))) +
    theme(plot.title = element_text(hjust = 0.5)) + xlab("Year") + 
    ylab("Regulatory Fragmentation") + 
    scale_color_manual(values = pl) + ylim(0.72,0.88)


```

\newpage

# **Figure 5:** $\Delta$ Regulation Dispersion

```{r changes}

int1 <- 2014:2016
int2 <- 2017:2019
lab1 <- "#Words in 2014-2016"
lab2 <- "#Words in 2017-2019"

difgraph <- function(int1, int2, lab1, lab2, data) {
  increases <- data[, list(regul1 = mean(AgencyDisp[year %in% int1]), 
                           regul2 = mean(AgencyDisp[year %in% int2])), by = TopicNumber]

  increases[, change := regul2 - regul1]
  setkey(increases, change)
  for(tp in as.numeric(1:100)) 
    increases[TopicNumber == tp,label1 := labels$ShortLabel[match(tp, labels$Topic)]]
  
  increases[, label1 := paste0(TopicNumber, ".", label1)]
  increases[, rank := 1:.N]
  increases[, label1 := paste0(strsplit(as.character(label1), "(?<=.{15})", 
                                        perl = TRUE)[[1]], collapse = "\n"), by = rank]
  
  increases <- increases[rank %in% c(1:3,98:100)]
  layers <- increases$label[c(6:4,1:3)]
  setkey(increases, rank)
  increases <- increases %>%
    select("TopicNumber", "label1", "regul1", "regul2", "rank") %>%
    melt(id.vars = c("TopicNumber", "label1", "rank")) 

  colnames(increases) <- c("topic", "label", "rank", "year", "reguldisp")

  increases[rank %in% 1:3, type := "2. Decrease"]
  increases[rank %in% 98:100, type := "1. Increase"]
  increases[year == "regul1", year:= lab1]
  increases[year == "regul2", year := lab2]

  increases$label <- factor(increases$label, levels = layers)

  plot <- increases %>%
    ggplot(aes(x = label, y = reguldisp, fill = year)) +
    geom_bar(stat = "identity", position = "dodge") + 
    facet_wrap(~type, scales = "free_x") + 
    th() + theme(axis.title.x=element_blank()) + 
    guides(fill=guide_legend(title="Period")) +
    #geom_text(aes(label = words.text, y = words), size = 2.5, 
    #          position=position_dodge(width=0.9), vjust=-0.25) + 
    scale_fill_brewer(palette = "Paired") + ylab("Dispersion Across Agencies") 
  
  return(plot)
}

cat("*Panel B: Topics with biggest change around 2016 presidential election*")
difgraph(2014:2016, 2017:2019, "2014-2016","2017-2019", data = agencydisp) %>% print
```

```{r}
difgraph(2006:2008, 2009:2011, "2006-2008","2009-2011", data = agencydisp) %>% print
```

# **Figure 6: A case study**

```{r}
top_agencies <- function(years, TP){
  require(scales)
  my_palette <- c("#E74C3C", "#3498DB", "#2ECC71", "#9B59B6", "#F1C40F",
                "#E67E22", "#1ABC9C", "#000000", "#C0392B", "#2980B9",
                "#ade5e5", "#8E44AD")

sorted_data <- topicagencyyear[order(-topicagencyyear$AgencyPercent), ]
top_10_agencies <- sorted_data[year == min(years) & TopicNumber == TP, agency][1:10]
data <- topicagencyyear[year %in% years & TopicNumber == TP]
data$Agency <- mapagency$label[match(data$agency, mapagency$agency)]
data[is.na(Agency), Agency := agency]
data <- data[agency %in% top_10_agencies]

data$Agency <- factor(data$Agency, levels = unique(data[match(top_10_agencies, data$agency), ]$Agency))

pl <- ggplot(data, aes(x = Agency, y = TopicWords, fill = Agency)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ year) +
  scale_fill_manual(values = my_palette) +
  scale_y_continuous(labels = comma) +
  ylab("Words written by an agency on selected topic") + 
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "bottom",
        axis.line = element_line(size = rel(1), colour = "black"),
        panel.grid.major = element_line(colour = "#d3d3d3"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        plot.title = element_text(size = rel(1.5), face = "bold", hjust = 0.5),
        axis.title.y = element_text(colour = "black", size = rel(1.2)),
        axis.text.y = element_text(colour = "black", size = rel(1.2)))
return(pl)
}

top_agencies(2014:2019, 29)
```

```{r}


plot_top_companies <- function(years, TP, shockyr){
  my_palette <- c("#E74C3C", "#3498DB", "#2ECC71", "#9B59B6", "#F1C40F",
                  "#E67E22", "#1ABC9C", "#000000", "#C0392B", "#2980B9",
                  "#ade5e5", "#8E44AD", "#ade5e5", "#8E44AD")
  
  data <- companyyear[year %in% years] %>% select("cik", "year", "name", TP, "regul.disp") 
  
  setkey(data, cik, year)
  data[, n1 := .N, by = cik]
  data <- data[n1 > 5]
  data[, name := substr((name[1]), 1, 35), by = cik]
  
  
  data <- data[order(data[[4]], decreasing = T)]
  data[, n2 := 1:.N, by = "year"]
  setkey(data, name, year)
  data[, n3 := n2[1], by = name]
  data <- data[n3 %in% 1:12]
  
  
  data$name <- factor(data$name, levels = unique(data[order(n3)]$name))
  
  pl <- data %>% 
    ggplot(aes(x = year, y = regul.disp, group = name, col = name, fill = name)) + 
    geom_line(alpha = 0.7, size = 1.5) + 
    theme(legend.position = "bottom") + 
    theme(axis.line = element_line(size=rel(1), colour = "black"), 
          panel.grid.major = element_line(colour = "#d3d3d3"), 
          panel.grid.minor = element_blank(), 
          panel.border = element_blank(), panel.background = element_blank(),
          plot.title = element_text(size = rel(1.5), face = "bold"),
          axis.text.x=element_text(colour="black", size = rel(1.0)),
          axis.title.x = element_text(colour="black", size = rel(1)),
          legend.title = element_blank(), 
          legend.text = element_text(size = rel(0.6)),
          axis.title.y = element_text(colour="black", size = rel(1.2))) +
    theme(plot.title = element_text(hjust = 0.5)) + xlab("Year") + 
    ylab("Regulatory Fragmentation") + 
    scale_color_manual(values = my_palette, name = "Company Name") + 
    ylim(0.70,0.85) +
    guides(col = guide_legend(title.position = "left", label.position = "right", ncol = 5)) + 
    geom_vline(xintercept=shockyr, linetype="dashed", color = "red")
  return(pl)
}

plot_top_companies(2014:2019, "Topic29", 2016) %>% print
```

\newpage

# **Table 1:**

# **Table 2: Verification**

All variables are normalized 

```{r}
yvars <- c( "company_FR.frag" , "agencies_10K.frag") %>% paste0("_norm")
line <- controls %>% paste0(collapse = " + ") %>% paste(yvars, "~ ",.,"|FF48_year + FF48 + cik + year")

reg <- NULL
for(i in 1:length(line)) reg[[yvars[i]]] <- feols(as.formula(line[i]), data = companyyear)

reg %>% ms_all
```

# **Table 3: Descriptive statistics**

```{r descriptive, include = F}
out <- NULL
qnts.topic <- quantile(companyyear$topic.disp, c(0.2,0.4,0.6,0.8))
qnts.regul <- quantile(companyyear$regul.disp, c(0.2,0.4,0.6,0.8))

data <- companyyear[topic.disp <= 0.2]
ind <- NULL
ind[[1]] <- which(companyyear$topic.disp <= qnts.topic[1])
ind[[2]] <- which(companyyear$topic.disp <= qnts.topic[2] & companyyear$topic.disp > qnts.topic[1])
ind[[3]] <- which(companyyear$topic.disp <= qnts.topic[3] & companyyear$topic.disp > qnts.topic[2])
ind[[4]] <- which(companyyear$topic.disp <= qnts.topic[4] & companyyear$topic.disp > qnts.topic[3])
ind[[5]] <- which(companyyear$topic.disp > qnts.topic[4])
ind[[6]] <- which(companyyear$regul.disp <= qnts.regul[1])
ind[[7]] <- which(companyyear$regul.disp <= qnts.regul[2] & companyyear$regul.disp > qnts.regul[1])
ind[[8]] <- which(companyyear$regul.disp <= qnts.regul[3] & companyyear$regul.disp > qnts.regul[2])
ind[[9]] <- which(companyyear$regul.disp <= qnts.regul[4] & companyyear$regul.disp > qnts.regul[3])
ind[[10]] <- which(companyyear$regul.disp > qnts.regul[4])

out <- data.table(Variable = "", T1 = "Topic", T2 = "Topic", T3 = "Topic", T4 = "Topic", T5 = "Topic",
                  R1 = "Regul", R2 = "Regul", R3 = "Regul", R4 = "Regul", R5 = "Regul")

out <- out %>% rbind(list("Quant","0%-20%","20%-40%", "40%-60%","60%-80%","80%-100%","0%-20%","20%-40%", "40%-60%","60%-80%","80%-100%"))  


comma <- function(x) formatC(x, big.mark=",")
mr <- function(x, n = 3) return(round(mean(x[!is.infinite(x)],na.rm = T),n))

companyyear$Nsegments <- win(companyyear$Nsegments)
companyyear$MB <- win(companyyear$MB)
companyyear$growth <- win(companyyear$growth)
companyyear$growth.at <- win(companyyear$growth.at)
companyyear$sga_at <- win(companyyear$sga_at)
companyyear$emp_at <- win(companyyear$emp_at)
companyyear$inv_at <- win(companyyear$inv_at)
companyyear$roa <- win(companyyear$roa)

vec <- c("# Obs.", comma(sapply(ind, length))) %>% as.list
out <- out %>% rbind(vec) 


vec <- c("Topic Dispersion", sapply(ind, function(x) mr(companyyear[x]$topic.disp))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("Regulation Dispersion", sapply(ind, function(x) mr(companyyear[x]$regul.disp))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("Sale", sapply(ind, function(x) mr(companyyear[x]$sale))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("TFP", sapply(ind, function(x) mr(companyyear[x]$tfp))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("N segments", sapply(ind, function(x) mr(companyyear[x]$Nsegments))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("PPE/AT", sapply(ind, function(x) mr(companyyear[x]$ppe_at))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("EBITDA/AT", sapply(ind, function(x) mr(companyyear[x]$ebitda_at))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("MB", sapply(ind, function(x) mr(companyyear[x]$MB))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("Sales Growth, %", sapply(ind, function(x) mr(companyyear[x]$growth))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("Assets Growth, %", sapply(ind, function(x) mr(companyyear[x]$growth.at))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("Tobin's Q", sapply(ind, function(x) mr(companyyear[x]$tobin))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("SGA/AT", sapply(ind, function(x) mr(companyyear[x]$sga_at))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("EMP/AT", sapply(ind, function(x) mr(companyyear[x]$emp_at))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("INVST/AT", sapply(ind, function(x) mr(companyyear[x]$inv_at))) %>% as.list
out <- out %>% rbind(vec) 

vec <- c("ROA, %", sapply(ind, function(x) mr(companyyear[x]$roa))) %>% as.list
out <- out %>% rbind(vec) 

out %>% flextable() %>% theme_box() %>% width(width = 1.3) 
```

\newpage

# **Table 4: SGA_AT, TFP, ROA next year**

All variables are normalized

```{r sga_tfp_roa}
reg_out <- function(y, ncols = 3) {
  y <- paste0(y, "_norm")
  fe <- c(rep("|FF48 + year + cik",ncols), rep("|FF48 + FF48_year + cik",ncols))

  line <- controls %>% paste0(collapse = " + ") %>% paste0(y, " ~ ", ., fe)
  reg <- NULL
  for(i in 1:length(line)) reg[[paste0(i, ".", y[i])]] <- feols(as.formula(line[i]), data = companyyear) 
  x <- modelsummary(reg, coef_map = cm, stars = c('*' = .1, '**' = 0.05 ,'***' = .01),
               gof_omit = 'DF|Deviance|AIC|BIC|Log.Lik|R2 Within|R2 Pseudo',coef_omit = "(Intercept)",
               output = "flextable") %>% 
    theme_box() %>% 
    width(width = 1.0) %>% 
    height(height = 0.15)
  return(x)
}


rep(c("lead.sga_at", "lead.tfp","lead.roa"), 2) |> reg_out()
```

\newpage

# **Table 5: Sales growth, assets growth, emp next year**

All variables are normalized

```{r growth_growthat_emp}
rep(c("lead.growth", "lead.growth.at","lead.emp_at"), 2) |> reg_out()
```

\newpage


# **Table 6: Fedreg Segments**

All variables are normalized


## Panel A1 *Notices*

```{r notices, results = "asis"}

reg_type <- function(tp) {
  yvars <- c("lead.sga_at", "lead.tfp", "lead.roa", "lead.growth", "lead.growth.at","lead.emp_at") %>% paste0("_norm")
  type_controls <- controls
  type_controls[1] <- paste0("regul.disp", tp, "_norm")
  type_controls[2] <- paste0("topic.disp", tp, "_norm")
  type_controls[3] <- paste0("regul.complex.log", tp, "_norm")
  line <- paste0(type_controls, collapse = " + ") %>% paste0(yvars, " ~ ", .,"|FF48 + FF48_year + cik")
  labs <- c("sga", "tfp", "roa", "growth", "growth_at", "emp")
  reg <- NULL

  for(i in 1:length(yvars)){
    reg[[labs[i]]] <- feols(as.formula(line[[i]]), data = companyyear)
  }

  return(reg)
}

"_Notice" %>% reg_type() %>% ms()
```

\newpage



## Panel A2 *Rules*

```{r rule, results = "asis"}
"_Rule" %>% reg_type() %>% ms()
```


## Panel B1 *RIN*

```{r rin, results = "asis"}
"_RIN" %>% reg_type() %>% ms()
```

## Panel B2 *Old RIN*

```{r old_rin, results = "asis"}
"_old_RIN" %>% reg_type() %>% ms()
```



# **Table 7: Subsamples**

All variables are normalized

## Panel A

Model 1 keeps observations in the same icode-500 HP industry code. Model 2 keeps observations with the same number of segments, Model 3 keep observations with the change in total assets below 20%

```{r}
companyyear[,`:=`(index1 = 0, index2 = 0, index3 = 0)]
companyyear[lead.icode500 != icode500, index1 := 1]
companyyear[lead.Nsegments != Nsegments, index2 := 1]
companyyear[abs(growth.at) > 20, index3 := 1]
logic <- NULL
logic[[1]] <- companyyear$index1 == 0
logic[[2]] <- companyyear$index2 == 0
logic[[3]] <- companyyear$index3 == 0
logic[[4]] <- companyyear$index1 == 0
logic[[5]] <- companyyear$index2 == 0
logic[[6]] <- companyyear$index3 == 0
logic[[7]] <- companyyear$index1 == 0
logic[[8]] <- companyyear$index2 == 0
logic[[9]] <- companyyear$index3 == 0


yvars_sub <- c(rep("lead.sga_at",3), rep("lead.tfp", 3), rep("lead.growth",3)) %>% paste0("_norm") 

line_sub <- controls %>% paste0(collapse = " + ") %>% paste0(yvars_sub, " ~ ", ., "|FF48 + cik + year")
  
lab <- c("SGA|ind", "SGA|seg", "SGA|size", "TFP|ind", "TFP|seg", "TFP|size", 
         "Grwoth|ind", "Growth|seg", "Growth|size")
reg <- NULL
for(i in 1:9){
  reg[[lab[i]]] <- feols(as.formula(line_sub[[i]]), companyyear[logic[[i]]]) 
}

reg %>% ms
```

\newpage

# **Table 8: Industry Composition**

All variables are normalized

```{r}
yvars <- c( "lead.n_ipo", "lead.n_join", "lead.n_left","lead.n_peers") %>% paste0("_norm")
line <- controls %>% paste0(collapse = " + ") %>% paste(yvars, "~ ",.,"|FF48 + FF48_year + cik + year")

reg <- NULL
for(i in 1:length(line)) reg[[yvars[i]]] <- feols(as.formula(line[[i]]), data = companyyear)

reg %>% ms
```




# **Table 9 Coauthored Topics **

```{r}
yvars <- c("lead.sga_at", "lead.tfp", "lead.roa", "lead.growth", "lead.growth.at","lead.emp_at") %>% paste0("_norm")
end <- " ~ regul.disp_norm*coauthored + regul.complex.log_norm*coauthored + topic.disp_norm*coauthored + LogWords10K_norm*coauthored + ppe_at_norm*coauthored + ebitda_at_norm*coauthored + log_sale_norm*coauthored + tobin_norm*coauthored|FF48 + FF48_year + cik"

line <- paste(yvars, end)
reg <- NULL
for(i in 1:6) reg[[yvars[i]]] <- feols(as.formula(line[[i]]), companyyear) 

reg %>% ms
```


\newpage

# **Table 10 Lobby next year**

All variables are normalized

Dependent variable: log of (1 + lobby expenses next year).

-   Average of lobby expenses next year = `r format(mean(companyyear$lead.lobby, na.rm = T), nsmall = 0)` dollars

-   Average of log 1 + lobby expenses next year = `r format(mean(companyyear$lead.log_lobby, na.rm = T), nsmall = 0)` dollars

-   standard deviation of log 1 + lobby expenses next year = `r format(sd(companyyear$lead.log_lobby, na.rm = T), nsmall = 0)` dollars

```{r lobby_atreg}
rep(c("lead.log_lobby", "lead.lobby"), 2) %>%  reg_out(.,ncol = 2)
```


# **Table 11**

```{r}
############################################################################
###################### LOADING EMPLOYMENT FILE  ############################
############################################################################

emp_data <- fread("/Users/evolkova/Dropbox/Projects/Govt Agenda/Sandbox/20230401/emp_data.csv")
cols <- c("N_hired","total_adjbase", "increase_adjbase", "average_increase_adjbase", "N_emp", 
          "median_increase_adjbase", "max_increase_adjbase", "N_promotions", "unexpected_promotion", "exit_private")

for(cl in cols) emp_data[, (paste0("lead.", cl)) := shift(.SD, n = 1, type = "lead"), .SDcols = cl, by = agysub_full]

############################################################################
###################### LOADING AGENCIES FILE  ##############################
############################################################################

agencies <-  "/Users/evolkova/Dropbox/Projects/Govt Agenda//Data/Agencies.csv" |> fread()
agencies[ clean.sub_agency == "-",  clean.sub_agency := clean.parent_agency ]
fedreg_master <- fread("/Users/evolkova/Dropbox/Projects/Govt Agenda/Data/masterfile_fedreg.csv", select = c("type", "document_number"))

agencies <- left_join(agencies, fedreg_master)
agencies[, agysub_full := clean.sub_agency]
agency_data <- agencies[!is.na(year),list(N_Rule = length(unique(document_number[type == "Rule"])),
                                 N_Notice = length(unique(document_number[type == "Notice"])),
                                 Words_Rule = sum(nwords[type == "Rule"], na.rm = T),
                                 Words_PRule = sum(nwords[type == "Proposed Rule"], na.rm = T),
                                 Words_Notice = sum(nwords[type == "Notice"], na.rm = T)),by = "agysub_full,year"]

emp_data <- emp_data %>% 
  left_join(agency_data)


for(i in 3:dim(emp_data)[2]) emp_data[[i]] <- nm(win(emp_data[[i]], 0.01))


topicsubagencyyear <- fread("/Users/evolkova/Dropbox/Projects/Govt Agenda/Sandbox/20230401/topicsubagencyyear.csv",
                            select = c("agency", "year", "TopicWords", "TopicNumber")) %>% 
  rename(agysub_full = agency) 

topicsubagencyyear <- topicsubagencyyear[order(TopicWords)]
topicsubagencyyear[, Rank := 1:100, by = "agysub_full,year"]
topicsubagencyyear[, AgencyWords := sum(TopicWords), by = "agysub_full,year"]
setkey(topicsubagencyyear, agysub_full, TopicNumber, year)
topicsubagencyyear[, lag.Rank := shift(Rank, n = 1, type = "lag"), by = "agysub_full,TopicNumber"]
topic_data <- topicsubagencyyear[, list(Words_hightopic = sum(TopicWords[lag.Rank %in% 90:100])/AgencyWords[1],
                                        AgencyWords = AgencyWords[1]), by = "agysub_full,year"]

emp_data <- emp_data %>% 
  left_join(topic_data)


for(i in 3:dim(emp_data)[2]) emp_data[[i]] <- nm(win(emp_data[[i]], 0.01))

cm1 <- c("Words_Notice" = "Words_Notice",
       "Words_PRule" = "Words_PRule",
       "Words_Rule" = "Words_Rule",
       "Words_Notice:Words_hightopic" = "Words_Notice × Words_hightopic",
       "Words_PRule:Words_hightopic" = "Words_PRule × Words_hightopic",
       "Words_Rule:Words_hightopic" = "Words_Rule × Words_hightopic",
       "Words_hightopic" = "Words_hightopic")



line <- NULL
line[[1]] <- "lead.unexpected_promotion ~ Words_Notice*Words_hightopic|year + agysub_full"
line[[2]] <- "lead.unexpected_promotion ~ Words_Rule*Words_hightopic|year + agysub_full"

reg <- NULL

labs <- paste(1:2, c("Unexpected Promotion", "Unexpected Promotion"))
for(i in 1:length(line)) reg[[labs[i]]] <- feols(as.formula(line[[i]]), data = emp_data)

modelsummary(reg, stars = c('*' = .1, '**' = 0.05 ,'***' = .01),
             gof_omit = 'DF|Deviance|AIC|BIC|Log.Lik|R2 Within|R2 Pseudo',
             coef_map = cm1)
```


