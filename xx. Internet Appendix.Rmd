---
title: "Internet Appendix"
author: "Kalmenovitz, Lowry, Volkova"
date: "2021-11-20"
output:
  word_document: 
    fig_caption: yes
    fig_height: 3.65
    fig_width: 7.5
    reference_docx: /Users/evolkova/Dropbox/style_reference.docx
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
fontsize: 10pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

require(ggplot2)
require(data.table)
require(lubridate)
require(ggthemes)
require(dplyr)
require(RColorBrewer)
require(rmarkdown)
require(knitr)

require(modelsummary)
require(fixest)
require(flextable)
require(psych)
require(wordcloud)

path <- "/Users/evolkova/Dropbox/Projects/Govt Agenda/"

temp_path <- path %>%
  paste0("Sandbox/20201029/temp_files/")

data_path <- path %>%
  paste0("/Data/")

th1 <- function() {
  theme(axis.line = element_line(size=rel(1), colour = "black"), 
        panel.grid.major = element_line(colour = "#d3d3d3"), 
        panel.grid.minor = element_blank(), 
        panel.border = element_blank(), panel.background = element_blank(),
        plot.title = element_text(size = rel(1.5), family = "Calibri", face = "bold"),
        text=element_text(family="Calibri"), 
        axis.text.x=element_text(colour="black", size = rel(1.3)),
        axis.title.x = element_text(colour="black", size = rel(1.3)),
        axis.title.y = element_text(colour="black", size = rel(1.3)),
        axis.text.y=element_text(colour="black", size = rel(1.4))) +
    theme(plot.title = element_text(hjust = 0.5))
}

th <- function() {
  theme_minimal() + 
  theme(legend.position='bottom', text=element_text(family="Georgia")) +
  theme(legend.title = element_text(size = rel(0.75)), 
        legend.text = element_text(size = rel(0.75)))  
}


topics.prob.all <- readRDS(paste0(temp_path, "topics.prob.rds"))
topics.prob <- topics.prob.all[!duplicated(document_number)]

tmp <- topics.prob
for(i in 1:100) tmp[[i]] <- tmp[[i]]*topics.prob$nwords

topiccols <- c(1:100, "nwords")
topics.prob.yeartype <- tmp[, lapply(.SD, . %>% sum), by = .(type,year), .SDcols = topiccols]
topics.prob.year <- tmp[, lapply(.SD, . %>% sum), by = .(year), .SDcols = topiccols]


### load topic to agency
topicstoagencies <- temp_path %>%
  paste0("topicagencyyear.csv") %>%
  fread

### load company year data
companyyear <- "companyyear.rds" %>% 
  paste0(data_path,.) %>%
  readRDS

wordcloudlist <- "wordcloudlist.rds" %>% 
  paste0(temp_path,.) %>%
  readRDS

labels <- "./Data/topic_labels_ML_KV_JK.csv" %>%
  paste0(path,.) %>% 
  fread

companyyear[, `:=`(log_sale = log(1 + sale), 
                   fcf_at = fcf/at,
                   LogWords10K = log(Words10K))]

vars <- c("log_sale", "ppe_at", "ebitda_at", "sale",
          "growth", "tobin", 
          "regul.disp_Notice", "regul.complex_Notice", "regul.complex_Notice.log",  
          "regul.disp_PRule", "regul.complex_PRule", "regul.complex_PRule.log",  
          "regul.disp_Rule", "regul.complex_Rule", "regul.complex_Rule.log", 
          "regul.disp_RIN", "regul.complex_RIN", "regul.complex_RIN.log", 
          "regul.disp_old_RIN", "regul.complex_old_RIN", "regul.complex_old_RIN.log", 
          "regul.disp", "regul.complex", "regul.complex.log", 
          "regul.disp.group.JK", "regul.disp.group.KV", 
          "regul.complex.log.group.JK", "regul.complex.log.group.KV",
          "topic.disp", "LogWords10K",
          "lead.sga_at", "lead.capx_at", "lead.inv_at", "lead.emp_at", 
          "lead.leverage", "lead.growth", "lead.roa", "lead.cash_at", "lead.growth.at") 

controls_min <- " +  regul.complex.log + LogWords10K + ppe_at + ebitda_at + 
 log_sale + tobin" 

col <- which(colnames(companyyear) %in% vars)
ind <- companyyear$sale > 0

for(c in col) {
  ind <- ind & !is.na(companyyear[[c]]) & !is.nan(companyyear[[c]]) & !is.infinite(companyyear[[c]])
}

companyyear <- companyyear[ind]
companyyear[, lead.roa := 100*lead.roa]
companyyear[, roa := 100*roa]

win <- function(x, eps = 0.005){
  up <- quantile(x, na.rm = T, 1 - eps)
  down <- quantile(x, na.rm = T, eps)
  x[x>up] <- up
  x[x<down] <- down
  return(x)
}

for(c in col) companyyear[[c]] <- win(companyyear[[c]])

companyyear$lead.tfp <- win(companyyear$lead.tfp)
### here we correct coefficients names
cm <- c("regul.disp" = "Regulation Dispersion",
        "topic.disp" = "Topic Dispersion",
        "regul.complex.log" = "Regulation Complexity",
        "LogWords10K" = "Log(Word,10K)",
        "Nsegments" = "Nsegments",
        "ppe_at" = "PPE/AT",
        "ebitda_at" = "EBITDA/AT", 
        "emp_sale" = "Emp/Sale",
        "log_sale" = "Log(Sale)",
        "log_at" = "log(AT)",
        "growth" = "Sales Growth",
        "tobin" = "Tobin's Q",
        "fcf_at" = "FCF to AT",
        "(Intercept)" = "(Intercept)")

### here we correct the names
  mapagency <- data.table(agency = "environmental protection agency", label = "EPA") %>%
    rbind(list("department of health and human services", "DHHS")) %>%
    rbind(list("department of transportation", "Transportation")) %>%
    rbind(list("department of commerce","Commerce")) %>%
    rbind(list("securities and exchange commission", "SEC")) %>%
    rbind(list("department of interior", "DOI")) %>%
    rbind(list("department of agriculture", "USDA")) %>%
    rbind(list("department of energy", "DOE")) %>%
    rbind(list("department of labor", "DOL")) %>%
    rbind(list("department of treasury", "Treasury")) %>%
    rbind(list("department of justice", "DOJ")) %>%
    rbind(list("nuclear regulatory commission", "NRC")) %>%
    rbind(list("federal communications commission", "FCC")) %>%
    rbind(list("department of housing and urban developm", "HUD")) %>%
    rbind(list("federal reserve system", "FRS")) %>%
    rbind(list("international trade commission", "ITC")) %>% 
    rbind(list("federal energy regulatory commission", "FERC")) %>%
    rbind(list("commodity futures trading commission", "CFTC")) %>%
    rbind(list("department of veteran affairs", "DVA"))

  
topicagencyyear <- "./Data/topicagencyyear.csv" %>% 
  paste0(path,.) %>% 
  fread()

agencydisp <- topicagencyyear[,list(AgencyDisp = 1 - sum(AgencyPercent^2)),
                              by = "TopicNumber,year"]
  
ff12labels <- "./Data/Indlabels12.txt" %>%
  paste0(path,.) %>%
  readLines
setkey(mapagency, agency)

```